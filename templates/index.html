{% extends "base.html" %}

{% block title %}BloodPrint â€¢ Classify{% endblock %}

{% block head_extras %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="hero-section pt-4">
    <div class="container">
        <div class="row g-4 align-items-start">
            <div class="col-xl-4">
                <div class="glass-card p-4">
                    <h2 class="h4 text-accent mb-3">Upload Fingerprint Image</h2>
                    <p class="text-secondary small mb-4">Drag and drop a fingerprint scan or select a file to let our AI estimate the blood group.</p>
                    <form id="uploadForm" enctype="multipart/form-data" class="d-flex flex-column gap-3">
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt mb-3"></i>
                            <h5 class="mb-1 text-white">Drop image here</h5>
                            <p class="text-secondary small mb-0">or click to browse (PNG, JPG, BMP, GIF)</p>
                            <input type="file" id="fileInput" name="file" accept=".png,.jpg,.jpeg,.bmp,.gif" hidden>
                        </div>
                        <div class="text-center">
                            <button type="submit" id="uploadBtn" class="btn btn-cta w-100" disabled>
                                <i class="fas fa-fingerprint me-2"></i>Analyze Fingerprint
                            </button>
                        </div>
                    </form>
                    <div class="facts-box mt-4" id="imagePreview" style="display:none;"></div>
                    <div class="loading-spinner" id="loadingSpinner" style="display:none;">
                        <div class="spinner-border" role="status"></div>
                        <p class="mt-2 text-secondary">Analyzing fingerprint...</p>
                    </div>
                    <div class="facts-box mt-3">
                        <h6 class="text-accent text-uppercase mb-2">Tips</h6>
                        <ul class="text-secondary small mb-0 list-unstyled">
                            <li class="mb-2"><i class="fas fa-check-circle text-accent me-2"></i>Use clear, high-contrast fingerprint scans.</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-accent me-2"></i>Crop tightly around the fingerprint ridge pattern.</li>
                            <li><i class="fas fa-check-circle text-accent me-2"></i>Supported formats: PNG, JPG, BMP, GIF.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-xl-8">
                <div class="result-card" id="resultContainer" style="display:none;">
                    <div class="row g-4 align-items-center mb-4">
                        <div class="col-md-4 text-center">
                            <div class="result-badge" id="predictedBadge">--</div>
                            <p class="mb-0 text-secondary">Predicted Blood Group</p>
                            <p class="h5 mt-2" id="confidenceText">Confidence: --</p>
                        </div>
                        <div class="col-md-8">
                            <h3 class="section-title mb-3">Prediction Results</h3>
                            <div class="progress-bar-slim mb-3">
                                <span id="confidenceBar" style="width:0%;"></span>
                            </div>
                            <canvas id="probabilityChart" height="140"></canvas>
                        </div>
                    </div>
                    <div class="top3-grid mb-4" id="top3Container"></div>
                    <div class="facts-box">
                        <h6 class="text-accent text-uppercase mb-2">Blood Group Facts</h6>
                        <p class="text-secondary small mb-1" id="factText">Upload a fingerprint to see interesting facts about the predicted blood group.</p>
                        <p class="text-secondary small mb-0">Reminder: This system is for educational and research purposes. Confirm results with certified laboratory tests.</p>
                    </div>
                </div>
                <div class="result-card text-center" id="placeholderCard">
                    <div class="position-relative d-inline-flex align-items-center justify-content-center mb-4" style="width:140px;height:140px;border-radius:50%;background:rgba(40,123,255,0.1);border:2px dashed rgba(77,157,255,0.4);">
                        <i class="fas fa-fingerprint fa-3x text-accent"></i>
                    </div>
                    <h3 class="section-title mb-2">Awaiting Analysis</h3>
                    <p class="text-secondary">Upload a fingerprint image to generate probabilities for each blood group and view detailed insights.</p>
                </div>
                <div id="errorAlert" class="alert alert-danger mt-3" style="display:none;"></div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block body_scripts %}
{{ super() }}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultContainer = document.getElementById('resultContainer');
    const placeholderCard = document.getElementById('placeholderCard');
    const predictedBadge = document.getElementById('predictedBadge');
    const confidenceText = document.getElementById('confidenceText');
    const confidenceBar = document.getElementById('confidenceBar');
    const top3Container = document.getElementById('top3Container');
    const factText = document.getElementById('factText');
    const imagePreview = document.getElementById('imagePreview');
    const errorAlert = document.getElementById('errorAlert');

    const bloodFacts = {
        'A+': 'A+ individuals can donate to A+ and AB+ recipients and are common in approximately 30% of the population.',
        'A-': 'A- blood is rarer and often needed for emergency transfusions where Rh-negative blood is required.',
        'B+': 'B+ donors can give to B+ and AB+ recipients; this type represents about 9% of people worldwide.',
        'B-': 'B- is one of the rarest blood groups, making its donors highly valuable for B- and AB- patients.',
        'AB+': 'AB+ is the universal recipient but can only donate to other AB+ recipients.',
        'AB-': 'AB- is extremely rare (less than 1% globally) and can receive from all Rh-negative groups.',
        'O+': 'O+ is the most common type and can donate to any Rh-positive recipient, covering roughly 38% of people.',
        'O-': 'O- is the universal donor, critical for emergencies, and found in about 7% of the population.'
    };

    let probabilityChart;

    function initChart() {
        const ctx = document.getElementById('probabilityChart').getContext('2d');
        probabilityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'],
                datasets: [{
                    label: 'Probability (%)',
                    data: Array(8).fill(0),
                    backgroundColor: 'rgba(77, 157, 255, 0.45)',
                    borderColor: 'rgba(77, 157, 255, 0.9)',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#b7c0d1' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    x: {
                        ticks: { color: '#b7c0d1' },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });
        fileInput.addEventListener('change', handleFileSelect);
        uploadForm.addEventListener('submit', handleSubmit);
    });

    function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Analyze Fingerprint';
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.style.display = 'block';
                imagePreview.innerHTML = `
                    <h6 class="text-accent text-uppercase mb-2">Selected Image</h6>
                    <img src="${e.target.result}" alt="Preview" class="preview-image mb-2" style="max-height:200px;object-fit:cover;width:100%;border-radius:16px;">
                    <p class="text-secondary small mb-0">${file.name}</p>`;
            };
            reader.readAsDataURL(file);
            errorAlert.style.display = 'none';
        }
    }

    async function handleSubmit(e) {
        e.preventDefault();
        if (!fileInput.files.length) {
            showError('Please select an image before analyzing.');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        loadingSpinner.style.display = 'block';
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
        errorAlert.style.display = 'none';

        try {
            const response = await fetch('/predict', { method: 'POST', body: formData });
            const data = await response.json();
            loadingSpinner.style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Analyze Fingerprint';

            if (data.success) {
                populateResults(data);
            } else {
                showError(data.error || 'An error occurred during analysis.');
            }
        } catch (error) {
            loadingSpinner.style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Analyze Fingerprint';
            showError('Unable to connect to the server. Please try again.');
        }
    }

    function populateResults(data) {
        placeholderCard.style.display = 'none';
        resultContainer.style.display = 'block';
        predictedBadge.textContent = data.blood_group || '--';
        confidenceText.textContent = `Confidence: ${data.confidence || '--'}`;
        const numericConfidence = parseFloat(data.confidence) || 0;
        confidenceBar.style.width = `${numericConfidence}%`;

        if (probabilityChart) {
            const labelOrder = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
            const dataset = labelOrder.map(label => {
                const entry = (data.top3 || []).find(item => item.blood_group === label);
                if (entry) {
                    return parseFloat(entry.confidence);
                }
                if (label === data.blood_group) {
                    return numericConfidence;
                }
                return 0;
            });
            probabilityChart.data.datasets[0].data = dataset;
            probabilityChart.update();
        }

        top3Container.innerHTML = (data.top3 || []).map((item, index) => {
            const value = parseFloat(item.confidence).toFixed(2);
            return `
                <div class="top3-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-semibold">#${index + 1} ${item.blood_group}</span>
                        <span class="text-secondary">${value}%</span>
                    </div>
                    <div class="progress-bar-slim">
                        <span style="width:${value}%;"></span>
                    </div>
                </div>`;
        }).join('');

        factText.textContent = bloodFacts[data.blood_group] || 'No additional information available for this blood group.';
    }

    function showError(message) {
        errorAlert.textContent = message;
        errorAlert.style.display = 'block';
        resultContainer.style.display = 'none';
        placeholderCard.style.display = 'block';
    }
</script>
{% endblock %}